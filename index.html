<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mukka Yethu Be - Online Card Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: 
                repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,.05) 10px, rgba(255,255,255,.05) 20px),
                linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 25%, #c44569 50%, #556270 75%, #4ecdc4 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255, 107, 107, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(78, 205, 196, 0.3) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
        }

        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #fff;
            margin: 20px 0;
            font-size: 2.5em;
            text-shadow: 
                0 0 10px #ff6b6b,
                0 0 20px #ff6b6b,
                0 0 30px #ff6b6b,
                0 0 40px #c44569,
                2px 2px 0px #4ecdc4;
            font-weight: bold;
            letter-spacing: 2px;
            animation: neonPulse 2s ease-in-out infinite alternate;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5em;
                margin: 10px 0;
                letter-spacing: 1px;
            }
        }

        @keyframes neonPulse {
            from {
                text-shadow: 
                    0 0 10px #ff6b6b,
                    0 0 20px #ff6b6b,
                    0 0 30px #ff6b6b,
                    0 0 40px #c44569,
                    2px 2px 0px #4ecdc4;
            }
            to {
                text-shadow: 
                    0 0 20px #ff6b6b,
                    0 0 30px #ff6b6b,
                    0 0 40px #ff6b6b,
                    0 0 50px #c44569,
                    3px 3px 0px #4ecdc4;
            }
        }

        .logo {
            display: inline-flex;
            gap: 5px;
        }

        .logo-card {
            width: 40px;
            height: 55px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border: 3px solid #333;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            box-shadow: 
                0 4px 0px #222,
                0 6px 8px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.5);
            animation: cardWiggle 2s infinite;
        }

        .logo-card:nth-child(1) {
            transform: rotate(-10deg);
            animation-delay: 0s;
        }

        .logo-card:nth-child(2) {
            transform: translateY(-5px);
            animation-delay: 0.3s;
            z-index: 2;
        }

        .logo-card:nth-child(3) {
            transform: rotate(10deg);
            animation-delay: 0.6s;
        }

        .logo-card.red { color: #d32f2f; }
        .logo-card.black { color: #333; }

        @keyframes cardWiggle {
            0%, 100% { transform: rotate(var(--rotation, 0deg)) translateY(0); }
            50% { transform: rotate(var(--rotation, 0deg)) translateY(-3px); }
        }

        /* Setup Screens */
        .setup-screen, .game-screen {
            display: none;
        }

        .setup-screen.active, .game-screen.active {
            display: block;
        }

        .setup-box {
            background: linear-gradient(145deg, #f5f5f5, #ffffff);
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            margin: 20px auto;
            box-shadow: 
                0 0 0 4px #333,
                0 0 0 8px #4ecdc4,
                0 10px 40px rgba(0,0,0,0.4);
            border: 4px solid #333;
            position: relative;
        }

        .setup-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0,0,0,0.03) 2px,
                rgba(0,0,0,0.03) 4px
            );
            pointer-events: none;
            border-radius: 8px;
        }

        .mode-btn {
            background: linear-gradient(145deg, #ff6b6b, #ee5a6f);
            color: white;
            border: 4px solid #333;
            padding: 20px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: all 0.1s;
            box-shadow: 
                0 6px 0 #c44569,
                0 8px 10px rgba(0,0,0,0.3);
            font-weight: bold;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
            position: relative;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 0 #c44569,
                0 10px 15px rgba(0,0,0,0.4);
        }

        .mode-btn:active {
            transform: translateY(4px);
            box-shadow: 
                0 2px 0 #c44569,
                0 3px 5px rgba(0,0,0,0.3);
        }

        .mode-btn.online {
            background: linear-gradient(145deg, #4ecdc4, #44a3a0);
            box-shadow: 
                0 6px 0 #36857f,
                0 8px 10px rgba(0,0,0,0.3);
        }

        .mode-btn.online:hover {
            box-shadow: 
                0 8px 0 #36857f,
                0 10px 15px rgba(0,0,0,0.4);
        }

        .mode-btn.online:active {
            box-shadow: 
                0 2px 0 #36857f,
                0 3px 5px rgba(0,0,0,0.3);
        }

        /* Avatar Selection */
        .avatar-section {
            text-align: center;
            margin: 20px 0;
        }

        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #e3f2fd;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            overflow: hidden;
            border: 3px solid #2a5298;
            cursor: pointer;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .emoji-picker {
            display: none;
            background: white;
            border: 2px solid #2a5298;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-picker.active {
            display: block;
        }

        .emoji-option {
            display: inline-block;
            font-size: 2em;
            padding: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .emoji-option:hover {
            transform: scale(1.3);
        }

        /* Game Table */
        .game-table {
            position: relative;
            width: 100%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .poker-table {
            background: 
                radial-gradient(ellipse at center, #2d5016 0%, #1a3a0f 100%);
            border: 15px solid;
            border-image: repeating-linear-gradient(
                45deg,
                #8b4513,
                #8b4513 10px,
                #a0522d 10px,
                #a0522d 20px
            ) 15;
            border-radius: 50%;
            width: 800px;
            height: 500px;
            margin: 0 auto;
            position: relative;
            box-shadow: 
                inset 0 0 50px rgba(0,0,0,0.5),
                0 0 0 4px #333,
                0 0 20px #ff6b6b,
                0 10px 50px rgba(0,0,0,0.5);
        }

        .poker-table::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 80%;
            border: 3px dashed rgba(255, 215, 0, 0.3);
            border-radius: 50%;
        }

        @media (max-width: 768px) {
            .poker-table {
                width: 100%;
                max-width: 400px;
                height: 300px;
                border-width: 8px;
            }
        }

        .table-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
        }

        .house-pot-display {
            background: linear-gradient(145deg, #ffd700, #ffed4e);
            color: #333;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.5em;
            font-weight: bold;
            box-shadow: 
                0 4px 0 #d4af37,
                0 6px 15px rgba(0,0,0,0.5),
                inset 0 -2px 0 rgba(0,0,0,0.2);
            margin-bottom: 20px;
            border: 4px solid #333;
            text-shadow: 2px 2px 0 rgba(255,255,255,0.5);
            animation: coinShine 3s infinite;
        }

        @keyframes coinShine {
            0%, 100% {
                box-shadow: 
                    0 4px 0 #d4af37,
                    0 6px 15px rgba(0,0,0,0.5),
                    inset 0 -2px 0 rgba(0,0,0,0.2);
            }
            50% {
                box-shadow: 
                    0 4px 0 #d4af37,
                    0 6px 15px rgba(0,0,0,0.5),
                    inset 0 -2px 0 rgba(0,0,0,0.2),
                    0 0 20px rgba(255, 215, 0, 0.6);
            }
        }

        .round-display {
            background: linear-gradient(145deg, #ff6b6b, #ee5a6f);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            border: 4px solid #333;
            box-shadow: 
                0 4px 0 #c44569,
                0 6px 10px rgba(0,0,0,0.5);
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }

        /* Player Positions */
        .player-position {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .player-position.pos-0 { bottom: -80px; left: 50%; transform: translateX(-50%); }
        .player-position.pos-1 { bottom: 50px; left: -120px; }
        .player-position.pos-2 { top: 50px; left: -120px; }
        .player-position.pos-3 { top: -80px; left: 50%; transform: translateX(-50%); }
        .player-position.pos-4 { top: 50px; right: -120px; }
        .player-position.pos-5 { bottom: 50px; right: -120px; }

        @media (max-width: 768px) {
            .player-position.pos-0 { bottom: -70px; left: 50%; }
            .player-position.pos-1 { bottom: 30px; left: -80px; }
            .player-position.pos-2 { top: 30px; left: -80px; }
            .player-position.pos-3 { top: -70px; left: 50%; }
            .player-position.pos-4 { top: 30px; right: -80px; }
            .player-position.pos-5 { bottom: 30px; right: -80px; }
        }

        .player-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid #ffd700;
            background: linear-gradient(145deg, #f0f0f0, #ffffff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            overflow: hidden;
            box-shadow: 
                0 0 0 4px #333,
                0 5px 15px rgba(0,0,0,0.5);
            transition: all 0.3s;
        }

        .player-avatar.active {
            border-color: #4ecdc4;
            box-shadow: 
                0 0 0 4px #333,
                0 0 20px #4ecdc4,
                0 0 30px #4ecdc4,
                0 5px 15px rgba(0,0,0,0.5);
            animation: retroPulse 1s infinite;
        }

        @keyframes retroPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 
                    0 0 0 4px #333,
                    0 0 20px #4ecdc4,
                    0 0 30px #4ecdc4,
                    0 5px 15px rgba(0,0,0,0.5);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 
                    0 0 0 4px #333,
                    0 0 30px #4ecdc4,
                    0 0 40px #4ecdc4,
                    0 5px 15px rgba(0,0,0,0.5);
            }
        }

        .player-avatar.spectator {
            border-color: #999;
            opacity: 0.6;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .player-info {
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        .player-name {
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 3px;
        }

        .player-stats {
            font-size: 0.85em;
            color: #666;
        }

        .player-stats .wins { color: #4caf50; }
        .player-stats .losses { color: #f44336; }

        .player-cards {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 5px;
        }

        .mini-card {
            width: 35px;
            height: 50px;
            background: white;
            border: 2px solid #333;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .mini-card.red { color: #d32f2f; }
        .mini-card.black { color: #333; }
        .mini-card .suit { font-size: 0.7em; }

        /* Card Reveal Animation */
        .card-reveal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .card-reveal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .big-card {
            width: 300px;
            height: 420px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border: 8px solid #333;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 8em;
            font-weight: bold;
            box-shadow: 
                0 0 0 4px #ffd700,
                0 20px 60px rgba(0,0,0,0.8),
                inset 0 0 100px rgba(255,255,255,0.1);
            animation: cardFlip 0.6s, cardGlow 2s infinite;
            position: relative;
        }

        @keyframes cardGlow {
            0%, 100% {
                box-shadow: 
                    0 0 0 4px #ffd700,
                    0 20px 60px rgba(0,0,0,0.8),
                    inset 0 0 100px rgba(255,255,255,0.1);
            }
            50% {
                box-shadow: 
                    0 0 0 4px #ffd700,
                    0 0 40px #ffd700,
                    0 20px 60px rgba(0,0,0,0.8),
                    inset 0 0 100px rgba(255,255,255,0.1);
            }
        }

        @keyframes cardFlip {
            0% { transform: rotateY(180deg) scale(0.5); }
            100% { transform: rotateY(0) scale(1); }
        }

        .big-card.red { color: #d32f2f; }
        .big-card.black { color: #333; }

        .big-card .suit {
            font-size: 0.3em;
            position: absolute;
            top: 20px;
            right: 20px;
        }

        /* Celebration/Mocking Effects */
        .celebration {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            animation: celebrate 1s;
            pointer-events: none;
        }

        @keyframes celebrate {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ffd700;
            position: absolute;
            animation: confettiFall 2s forwards;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Controls */
        .controls-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px auto;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .control-section {
            margin: 20px 0;
        }

        .control-section h3 {
            color: #1e3c72;
            margin-bottom: 15px;
        }

        button {
            background: linear-gradient(145deg, #ff6b6b, #ee5a6f);
            color: white;
            border: 4px solid #333;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.1s;
            margin: 5px;
            box-shadow: 
                0 4px 0 #c44569,
                0 6px 10px rgba(0,0,0,0.3);
            font-weight: bold;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 0 #c44569,
                0 8px 15px rgba(0,0,0,0.4);
        }

        button:active {
            transform: translateY(2px);
            box-shadow: 
                0 2px 0 #c44569,
                0 3px 5px rgba(0,0,0,0.3);
        }

        button:disabled {
            background: linear-gradient(145deg, #999, #888);
            cursor: not-allowed;
            transform: none;
            box-shadow: 
                0 4px 0 #666,
                0 6px 10px rgba(0,0,0,0.3);
        }

        button.primary {
            background: linear-gradient(145deg, #4ecdc4, #44a3a0);
            box-shadow: 
                0 4px 0 #36857f,
                0 6px 10px rgba(0,0,0,0.3);
        }

        button.primary:hover {
            box-shadow: 
                0 6px 0 #36857f,
                0 8px 15px rgba(0,0,0,0.4);
        }

        button.primary:active {
            box-shadow: 
                0 2px 0 #36857f,
                0 3px 5px rgba(0,0,0,0.3);
        }

        .bet-slider-container {
            margin: 20px 0;
        }

        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }

        .bet-amount {
            text-align: center;
            font-size: 2.5em;
            font-weight: bold;
            color: #2a5298;
            margin: 15px 0;
        }

        .quick-bets {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-bets button {
            flex: 1;
            min-width: 80px;
        }

        .guess-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .guess-buttons button {
            flex: 1;
            padding: 20px;
            font-size: 1.3em;
        }

        /* Result Message */
        .result-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
            display: none;
        }

        .result-panel.active {
            display: block;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-panel.win {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            border: 3px solid #4caf50;
        }

        .result-panel.loss {
            background: linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%);
            border: 3px solid #f44336;
        }

        .result-icon {
            font-size: 4em;
            margin-bottom: 10px;
        }

        .result-text {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        /* Spectator Banner */
        .spectator-banner {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .bet-options {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .bet-option {
            flex: 1;
            min-width: 80px;
            padding: 15px;
            border: 2px solid #2a5298;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .bet-option:hover {
            background: #e3f2fd;
        }

        .bet-option.selected {
            background: #2a5298;
            color: white;
        }

        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2a5298;
        }

        .game-code {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            border: 3px dashed #2a5298;
        }

        .game-code-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2a5298;
            letter-spacing: 5px;
            margin: 15px 0;
        }

        /* Chat Box */
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            height: 400px;
            background: linear-gradient(145deg, #f5f5f5, #ffffff);
            border-radius: 8px;
            box-shadow: 
                0 0 0 4px #333,
                0 0 0 8px #ff6b6b,
                0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: all 0.3s;
            border: 4px solid #333;
        }

        .chat-container.minimized {
            height: 60px;
        }

        .chat-header {
            background: linear-gradient(145deg, #ff6b6b, #ee5a6f);
            color: white;
            padding: 15px;
            border-radius: 4px 4px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 4px solid #333;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }

        .chat-header h3 {
            margin: 0;
            font-size: 1.1em;
        }

        .chat-toggle {
            background: linear-gradient(145deg, #4ecdc4, #44a3a0);
            border: 3px solid #333;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0 10px;
            margin: 0;
            width: auto;
            border-radius: 4px;
            box-shadow: 
                0 3px 0 #36857f,
                0 4px 5px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        .chat-toggle:active {
            transform: translateY(2px);
            box-shadow: 
                0 1px 0 #36857f,
                0 2px 3px rgba(0,0,0,0.3);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-message {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            animation: messageSlide 0.3s;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.own {
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #e3f2fd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0;
            border: 2px solid #2a5298;
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .chat-bubble {
            background: #e3f2fd;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .chat-message.own .chat-bubble {
            background: #2a5298;
            color: white;
        }

        .chat-sender {
            font-size: 0.8em;
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 3px;
        }

        .chat-message.own .chat-sender {
            color: rgba(255,255,255,0.8);
            text-align: right;
        }

        .chat-text {
            font-size: 0.95em;
            line-height: 1.4;
        }

        .chat-input-container {
            display: flex;
            gap: 8px;
            padding: 12px;
            border-top: 1px solid #ddd;
            background: #f5f5f5;
            border-radius: 0 0 15px 15px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 20px;
            font-size: 0.95em;
            outline: none;
        }

        .chat-input:focus {
            border-color: #2a5298;
        }

        .chat-send-btn {
            background: linear-gradient(145deg, #4ecdc4, #44a3a0);
            color: white;
            border: 3px solid #333;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.1s;
            margin: 0;
            box-shadow: 
                0 3px 0 #36857f,
                0 4px 5px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        .chat-send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 
                0 4px 0 #36857f,
                0 5px 8px rgba(0,0,0,0.4);
        }

        .chat-send-btn:active {
            transform: translateY(2px);
            box-shadow: 
                0 1px 0 #36857f,
                0 2px 3px rgba(0,0,0,0.3);
        }

        .chat-send-btn:disabled {
            background: linear-gradient(145deg, #999, #888);
            cursor: not-allowed;
            box-shadow: 
                0 3px 0 #666,
                0 4px 5px rgba(0,0,0,0.3);
        }

        /* Quick Reactions */
        .quick-reactions {
            display: flex;
            gap: 5px;
            padding: 0 12px 8px;
            overflow-x: auto;
        }

        .reaction-btn {
            background: white;
            border: 1px solid #ddd;
            border-radius: 15px;
            padding: 5px 10px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0;
            min-width: auto;
        }

        .reaction-btn:hover {
            transform: scale(1.2);
            background: #e3f2fd;
        }

        @media (max-width: 768px) {
            .chat-container {
                width: calc(100% - 40px);
                bottom: 10px;
                right: 10px;
                left: 10px;
            }
        }

        /* Game Over Modal */
        .game-over-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.5s;
        }

        .game-over-content {
            background: linear-gradient(145deg, #ffffff, #f5f5f5);
            border: 8px solid #333;
            border-radius: 15px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 
                0 0 0 4px #ff6b6b,
                0 0 40px #ff6b6b,
                0 20px 60px rgba(0,0,0,0.8);
            animation: gameOverBounce 0.6s;
        }

        @keyframes gameOverBounce {
            0% {
                transform: scale(0.3) rotate(-10deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.05) rotate(2deg);
            }
            100% {
                transform: scale(1) rotate(0);
                opacity: 1;
            }
        }

        .final-scores {
            max-height: 300px;
            overflow-y: auto;
        }

        .score-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            border: 3px solid #333;
            align-items: center;
        }

        .score-row.winner {
            background: linear-gradient(145deg, #ffd700, #ffed4e);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            border-color: #d4af37;
        }

        @media (max-width: 768px) {
            .game-over-content {
                padding: 20px;
            }
            
            .game-over-content h2 {
                font-size: 2em !important;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>
            <div class="logo">
                <div class="logo-card red">A‚ô•</div>
                <div class="logo-card black">K‚ô†</div>
                <div class="logo-card red">Q‚ô¶</div>
            </div>
            Mukka Yethu Be
        </h1>

        <!-- Mode Selection -->
        <div class="setup-screen active" id="modeSelection">
            <div class="setup-box">
                <h2 style="text-align: center; color: #2a5298; margin-bottom: 30px;">Choose Game Mode</h2>
                <button class="mode-btn" onclick="showLocalSetup()">
                    üì± Local Game<br>
                    <span style="font-size: 0.8em;">(Pass & Play)</span>
                </button>
                <button class="mode-btn online" onclick="showOnlineSetup()">
                    üåê Online Multiplayer<br>
                    <span style="font-size: 0.8em;">(Play with Friends Online)</span>
                </button>
            </div>
        </div>

        <!-- Local Setup -->
        <div class="setup-screen" id="localSetup">
            <div class="setup-box">
                <button onclick="backToModeSelection()" style="background: #666; margin-bottom: 20px;">‚Üê Back</button>
                <h2 style="text-align: center; color: #2a5298; margin-bottom: 20px;">Local Game Setup</h2>
                
                <label for="localPlayerCount">Number of Players (2-6):</label>
                <input type="number" id="localPlayerCount" min="2" max="6" value="2">
                
                <label>Select Ante (buy-in per player):</label>
                <div class="bet-options">
                    <div class="bet-option" onclick="selectAnteLocal(2)">$2</div>
                    <div class="bet-option" onclick="selectAnteLocal(5)">$5</div>
                    <div class="bet-option" onclick="selectAnteLocal(10)">$10</div>
                    <div class="bet-option" onclick="selectAnteLocal(20)">$20</div>
                </div>
                
                <button class="mode-btn primary" onclick="startLocalGame()">Start Game</button>
            </div>
        </div>

        <!-- Online Setup -->
        <div class="setup-screen" id="onlineSetup">
            <div class="setup-box">
                <button onclick="backToModeSelection()" style="background: #666; margin-bottom: 20px;">‚Üê Back</button>
                <h2 style="text-align: center; color: #2a5298; margin-bottom: 20px;">Online Multiplayer</h2>
                
                <div class="info-box">
                    üåê Play with friends online! Create a room or join with a code.
                </div>
                
                <button class="mode-btn primary" onclick="createRoom()">Create New Room</button>
                <button class="mode-btn" onclick="showJoinRoom()">Join Existing Room</button>
                
                <div id="joinRoomForm" class="hidden" style="margin-top: 20px;">
                    <label for="roomCodeInput">Enter Room Code:</label>
                    <input type="text" id="roomCodeInput" placeholder="ABC123" maxlength="6" style="text-transform: uppercase;">
                    <button class="mode-btn primary" onclick="joinRoom()">Join Room</button>
                </div>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div class="setup-screen" id="lobbyScreen">
            <div class="setup-box">
                <div class="game-code">
                    <div style="font-size: 1.2em; margin-bottom: 10px;">Room Code:</div>
                    <div class="game-code-value" id="roomCodeDisplay">------</div>
                    <button onclick="copyRoomCode()" style="background: #4caf50;">üìã Copy Code</button>
                    <button onclick="shareRoomLink()" style="background: #2196f3;">üîó Share Link</button>
                </div>

                <!-- Avatar Selection -->
                <div class="avatar-section">
                    <label>Choose Your Avatar:</label>
                    <div class="avatar-preview" id="avatarPreview" onclick="document.getElementById('avatarUpload').click()">
                        üë§
                    </div>
                    <input type="file" id="avatarUpload" accept="image/*" class="hidden" onchange="handleAvatarUpload()">
                    <button onclick="toggleEmojiPicker()">üòÄ Pick Emoji</button>
                    
                    <div class="emoji-picker" id="emojiPicker">
                        <span class="emoji-option" onclick="selectEmoji('üòÄ')">üòÄ</span>
                        <span class="emoji-option" onclick="selectEmoji('üòé')">üòé</span>
                        <span class="emoji-option" onclick="selectEmoji('ü§©')">ü§©</span>
                        <span class="emoji-option" onclick="selectEmoji('üòà')">üòà</span>
                        <span class="emoji-option" onclick="selectEmoji('ü§ì')">ü§ì</span>
                        <span class="emoji-option" onclick="selectEmoji('ü•≥')">ü•≥</span>
                        <span class="emoji-option" onclick="selectEmoji('ü§†')">ü§†</span>
                        <span class="emoji-option" onclick="selectEmoji('üëë')">üëë</span>
                        <span class="emoji-option" onclick="selectEmoji('üé≠')">üé≠</span>
                        <span class="emoji-option" onclick="selectEmoji('üé™')">üé™</span>
                        <span class="emoji-option" onclick="selectEmoji('üé®')">üé®</span>
                        <span class="emoji-option" onclick="selectEmoji('üéØ')">üéØ</span>
                    </div>
                </div>

                <label for="playerNameInput">Your Name:</label>
                <input type="text" id="playerNameInput" placeholder="Enter your name" maxlength="15">
                
                <label>Select Ante:</label>
                <div class="bet-options">
                    <div class="bet-option" onclick="selectAnteOnline(2)">$2</div>
                    <div class="bet-option" onclick="selectAnteOnline(5)">$5</div>
                    <div class="bet-option" onclick="selectAnteOnline(10)">$10</div>
                    <div class="bet-option" onclick="selectAnteOnline(20)">$20</div>
                </div>
                
                <button class="mode-btn primary" onclick="joinLobby()" id="joinLobbyBtn">Join Lobby</button>
                
                <div id="lobbyPlayersList" class="hidden" style="margin-top: 20px;">
                    <h3 style="color: #1e3c72; margin-bottom: 15px;">üë• Players in Lobby:</h3>
                    <div id="playersListContainer"></div>
                    <button class="mode-btn primary hidden" onclick="startOnlineGame()" id="startGameBtn">Start Game</button>
                </div>
                
                <button onclick="leaveLobby()" style="background: #f44336; margin-top: 20px;">Leave Lobby</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="game-screen" id="gameScreen">
            <!-- Spectator Banner -->
            <div class="spectator-banner hidden" id="spectatorBanner">
                üëÅÔ∏è SPECTATOR MODE - Game in Progress - You're watching!
            </div>

            <!-- Round Table -->
            <div class="game-table">
                <div class="poker-table">
                    <div class="table-center">
                        <div class="house-pot-display">
                            üè¶ House Pot: $<span id="housePotAmount">0</span>
                        </div>
                        <div class="round-display">
                            Round <span id="roundNumber">1</span>
                        </div>
                    </div>
                    
                    <!-- Player Positions (dynamically added) -->
                    <div id="playerPositions"></div>
                </div>
            </div>

            <!-- Controls Panel -->
            <div class="controls-panel" id="controlsPanel">
                <div class="control-section" id="currentTurnInfo">
                    <h3 style="text-align: center; color: #1e3c72; font-size: 1.5em;">
                        <span id="currentPlayerName">Player 1</span>'s Turn
                    </h3>
                </div>

                <!-- Betting Controls -->
                <div class="control-section hidden" id="bettingSection">
                    <h3>Place Your Bet</h3>
                    <div class="bet-amount">$<span id="betAmount">0</span></div>
                    <div class="bet-slider-container">
                        <input type="range" id="betSlider" min="2" max="100" value="2" oninput="updateBetDisplay()">
                        <div style="display: flex; justify-content: space-between; color: #666;">
                            <span>Min: $<span id="minBet">2</span></span>
                            <span>Max: $<span id="maxBet">100</span></span>
                        </div>
                    </div>
                    <div class="quick-bets">
                        <button onclick="setQuickBet(0.25)">25%</button>
                        <button onclick="setQuickBet(0.5)">50%</button>
                        <button onclick="setQuickBet(0.75)">75%</button>
                        <button onclick="setQuickBet(1)">MAX</button>
                    </div>
                    <button class="primary" onclick="confirmBet()" style="width: 100%; margin-top: 15px;">Confirm Bet</button>
                </div>

                <!-- Guess Controls -->
                <div class="control-section hidden" id="guessSection">
                    <h3>Make Your Guess</h3>
                    <div class="guess-buttons">
                        <button onclick="makeGuess('in')" style="background: #4caf50;">
                            ‚úì IN<br>(Between)
                        </button>
                        <button onclick="makeGuess('out')" style="background: #f44336;">
                            ‚úó OUT<br>(Outside)
                        </button>
                    </div>
                </div>

                <!-- Start Turn Button -->
                <button class="primary hidden" onclick="startTurn()" id="startTurnBtn" style="width: 100%; padding: 20px; font-size: 1.3em;">
                    üé¥ Place Bet
                </button>

                <!-- Waiting Message -->
                <div class="hidden" id="waitingMessage" style="text-align: center; padding: 30px; color: #666; font-size: 1.2em;">
                    ‚è≥ Waiting for other players...
                </div>
            </div>

            <!-- Result Panel -->
            <div class="result-panel" id="resultPanel">
                <div class="result-icon" id="resultIcon">üéâ</div>
                <div class="result-text" id="resultText">You won $10!</div>
            </div>

            <!-- Controls -->
            <div style="text-align: center; margin: 20px;">
                <button onclick="resetGame()" style="background: #f57f17;">üîÑ New Game</button>
            </div>
        </div>

        <!-- Chat Box -->
        <div class="chat-container" id="chatContainer" style="display: none;">
            <div class="chat-header" onclick="toggleChat()">
                <h3>üí¨ Chat</h3>
                <button class="chat-toggle" id="chatToggle">‚àí</button>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="quick-reactions">
                <button class="reaction-btn" onclick="sendReaction('üëç')">üëç</button>
                <button class="reaction-btn" onclick="sendReaction('üòÇ')">üòÇ</button>
                <button class="reaction-btn" onclick="sendReaction('üî•')">üî•</button>
                <button class="reaction-btn" onclick="sendReaction('üòé')">üòé</button>
                <button class="reaction-btn" onclick="sendReaction('üíØ')">üíØ</button>
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." maxlength="200" onkeypress="handleChatKeyPress(event)">
                <button class="chat-send-btn" onclick="sendChatMessage()">‚û§</button>
            </div>
        </div>

        <!-- Game Over Modal -->
        <div class="game-over-modal" id="gameOverModal" style="display: none;">
            <div class="game-over-content">
                <h2 style="color: #ff6b6b; font-size: 3em; margin-bottom: 20px; text-shadow: 0 0 20px #ff6b6b;">
                    üé∞ GAME OVER! üé∞
                </h2>
                <p style="font-size: 1.5em; margin-bottom: 30px;">
                    The house pot is empty!
                </p>
                
                <div class="final-scores" id="finalScores" style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 20px 0; border: 4px solid #333;">
                    <h3 style="color: #333; margin-bottom: 15px;">üèÜ Final Scores</h3>
                    <div id="finalScoresList"></div>
                </div>

                <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                    <button onclick="reBetSameGame()" class="primary" style="flex: 1; min-width: 200px; padding: 20px; font-size: 1.2em;">
                        üîÑ Re-Bet & Continue<br>
                        <span style="font-size: 0.8em;">(Same players, same ante)</span>
                    </button>
                    <button onclick="resetGame()" style="flex: 1; min-width: 200px; padding: 20px; font-size: 1.2em; background: linear-gradient(145deg, #ff6b6b, #ee5a6f);">
                        üè† New Game<br>
                        <span style="font-size: 0.8em;">(Start fresh)</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Card Reveal Overlay -->
        <div class="card-reveal-overlay" id="cardRevealOverlay">
            <div class="big-card" id="bigCard">
                <div class="suit" id="bigCardSuit">‚ô†</div>
                <div id="bigCardValue">A</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAVJ7uJJOoakUQg4qT4qK1SxTifVN3KvnI",
            authDomain: "anakapalli-card-game.firebaseapp.com",
            databaseURL: "https://anakapalli-card-game-default-rtdb.firebaseio.com",
            projectId: "anakapalli-card-game",
            storageBucket: "anakapalli-card-game.firebasestorage.app",
            messagingSenderId: "672935697255",
            appId: "1:672935697255:web:dfacec77e24410284badc2"
        };

        let app, database, isFirebaseEnabled = false;

        try {
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
            isFirebaseEnabled = true;
            console.log('‚úÖ Firebase initialized');
        } catch (error) {
            console.error('‚ùå Firebase initialization failed:', error);
        }

        // Game Constants
        const SUITS = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
        const VALUES = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        const VALUE_MAP = {'A': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13};

        // Game State
        let gameState = {
            mode: null, // 'local' or 'online'
            roomCode: null,
            players: [],
            currentPlayerIndex: 0,
            deck: [],
            playerHands: {},
            housePot: 0,
            ante: 0,
            currentBet: 0,
            betLocked: false,
            roundNumber: 1,
            drawnCard: null,
            myPlayerId: 'player_' + Math.random().toString(36).substr(2, 9),
            myAvatar: 'üë§',
            myAvatarType: 'emoji', // 'emoji' or 'image'
            myAvatarData: null,
            isSpectator: false
        };

        let gameStateListener = null;
        let turnAdvanceTimeout = null;

        // Helper function to remove undefined values for Firebase
        function cleanForFirebase(obj) {
            if (Array.isArray(obj)) {
                return obj.map(item => cleanForFirebase(item));
            } else if (obj !== null && typeof obj === 'object') {
                const cleaned = {};
                for (let key in obj) {
                    if (obj[key] !== undefined) {
                        cleaned[key] = cleanForFirebase(obj[key]);
                    }
                }
                return cleaned;
            }
            return obj;
        }

        // Expose functions globally
        window.showLocalSetup = showLocalSetup;
        window.showOnlineSetup = showOnlineSetup;
        window.backToModeSelection = backToModeSelection;
        window.selectAnteLocal = selectAnteLocal;
        window.selectAnteOnline = selectAnteOnline;
        window.startLocalGame = startLocalGame;
        window.createRoom = createRoom;
        window.showJoinRoom = showJoinRoom;
        window.joinRoom = joinRoom;
        window.copyRoomCode = copyRoomCode;
        window.shareRoomLink = shareRoomLink;
        window.handleAvatarUpload = handleAvatarUpload;
        window.toggleEmojiPicker = toggleEmojiPicker;
        window.selectEmoji = selectEmoji;
        window.joinLobby = joinLobby;
        window.startOnlineGame = startOnlineGame;
        window.leaveLobby = leaveLobby;
        window.startTurn = startTurn;
        window.updateBetDisplay = updateBetDisplay;
        window.setQuickBet = setQuickBet;
        window.confirmBet = confirmBet;
        window.makeGuess = makeGuess;
        window.resetGame = resetGame;
        window.toggleChat = toggleChat;
        window.sendChatMessage = sendChatMessage;
        window.sendReaction = sendReaction;
        window.handleChatKeyPress = handleChatKeyPress;
        window.reBetSameGame = reBetSameGame;

        // Navigation Functions
        function showLocalSetup() {
            hideAllScreens();
            document.getElementById('localSetup').classList.add('active');
            gameState.mode = 'local';
        }

        function showOnlineSetup() {
            if (!isFirebaseEnabled) {
                alert('Online multiplayer requires Firebase. Please check configuration.');
                return;
            }
            hideAllScreens();
            document.getElementById('onlineSetup').classList.add('active');
            gameState.mode = 'online';
        }

        function backToModeSelection() {
            hideAllScreens();
            document.getElementById('modeSelection').classList.add('active');
            gameState.mode = null;
        }

        function hideAllScreens() {
            document.querySelectorAll('.setup-screen, .game-screen').forEach(el => {
                el.classList.remove('active');
            });
        }

        // Ante Selection
        let selectedAnteLocal = 0;
        let selectedAnteOnline = 0;

        function selectAnteLocal(amount) {
            selectedAnteLocal = amount;
            document.querySelectorAll('#localSetup .bet-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function selectAnteOnline(amount) {
            selectedAnteOnline = amount;
            document.querySelectorAll('#lobbyScreen .bet-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        // Avatar Functions
        function handleAvatarUpload() {
            const file = document.getElementById('avatarUpload').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    gameState.myAvatarType = 'image';
                    gameState.myAvatarData = e.target.result;
                    document.getElementById('avatarPreview').innerHTML = `<img src="${e.target.result}" alt="Avatar">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function toggleEmojiPicker() {
            document.getElementById('emojiPicker').classList.toggle('active');
        }

        function selectEmoji(emoji) {
            gameState.myAvatarType = 'emoji';
            gameState.myAvatar = emoji;
            document.getElementById('avatarPreview').textContent = emoji;
            document.getElementById('emojiPicker').classList.remove('active');
        }

        // Deck Functions
        function createDeck() {
            const deck = [];
            for (let suit of SUITS) {
                for (let value of VALUES) {
                    deck.push({
                        suit,
                        value,
                        numValue: VALUE_MAP[value],
                        color: (suit === '‚ô•' || suit === '‚ô¶') ? 'red' : 'black'
                    });
                }
            }
            return shuffleDeck(deck);
        }

        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        // Local Game Functions
        function startLocalGame() {
            const playerCount = parseInt(document.getElementById('localPlayerCount').value);
            if (playerCount < 2 || playerCount > 6) {
                alert('Please enter 2-6 players');
                return;
            }
            if (selectedAnteLocal === 0) {
                alert('Please select an ante amount');
                return;
            }

            gameState.players = [];
            for (let i = 0; i < playerCount; i++) {
                gameState.players.push({
                    id: `local_${i}`,
                    name: `Player ${i + 1}`,
                    avatar: ['üòÄ', 'üòé', 'ü§©', 'üòà', 'ü§ì', 'ü•≥'][i] || 'üë§',
                    avatarType: 'emoji',
                    wins: 0,
                    losses: 0,
                    netWinnings: 0,
                    isSpectator: false
                });
            }

            gameState.ante = selectedAnteLocal;
            gameState.housePot = playerCount * selectedAnteLocal;
            gameState.deck = createDeck();
            gameState.currentPlayerIndex = 0;
            gameState.roundNumber = 1;

            dealInitialCards();
            showGameScreen();
        }

        function dealInitialCards() {
            gameState.playerHands = {};
            for (let i = 0; i < gameState.players.length; i++) {
                if (!gameState.players[i].isSpectator) {
                    gameState.playerHands[i] = [gameState.deck.pop(), gameState.deck.pop()];
                    gameState.playerHands[i].sort((a, b) => a.numValue - b.numValue);
                }
            }
        }

        // Online Game Functions
        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        async function createRoom() {
            if (!isFirebaseEnabled) {
                alert('Firebase not configured');
                return;
            }

            const roomCode = generateRoomCode();
            gameState.roomCode = roomCode;

            const roomRef = ref(database, `rooms/${roomCode}`);
            await set(roomRef, {
                code: roomCode,
                status: 'lobby',
                created: Date.now(),
                host: gameState.myPlayerId,
                players: {}
            });

            showLobby(roomCode);
        }

        function showJoinRoom() {
            document.getElementById('joinRoomForm').classList.remove('hidden');
        }

        async function joinRoom() {
            const roomCode = document.getElementById('roomCodeInput').value.toUpperCase().trim();
            if (!roomCode || roomCode.length !== 6) {
                alert('Please enter a valid 6-character room code');
                return;
            }

            const roomRef = ref(database, `rooms/${roomCode}`);
            const snapshot = await get(roomRef);

            if (!snapshot.exists()) {
                alert('Room not found');
                return;
            }

            const room = snapshot.val();
            
            // Check if game is in progress
            if (room.status === 'playing') {
                gameState.isSpectator = true;
                alert('Game in progress. You will join as a spectator.');
            }

            gameState.roomCode = roomCode;
            showLobby(roomCode);
        }

        function showLobby(roomCode) {
            hideAllScreens();
            document.getElementById('lobbyScreen').classList.add('active');
            document.getElementById('roomCodeDisplay').textContent = roomCode;
        }

        function copyRoomCode() {
            const code = document.getElementById('roomCodeDisplay').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('Room code copied!');
            });
        }

        function shareRoomLink() {
            const code = document.getElementById('roomCodeDisplay').textContent;
            const url = window.location.href.split('?')[0] + '?room=' + code;
            navigator.clipboard.writeText(url).then(() => {
                alert('Room link copied!');
            });
        }

        async function joinLobby() {
            const playerName = document.getElementById('playerNameInput').value.trim();
            if (!playerName) {
                alert('Please enter your name');
                return;
            }
            if (selectedAnteOnline === 0) {
                alert('Please select an ante');
                return;
            }

            // Add player to room
            const playerRef = ref(database, `rooms/${gameState.roomCode}/players/${gameState.myPlayerId}`);
            await set(playerRef, {
                id: gameState.myPlayerId,
                name: playerName,
                avatar: gameState.myAvatar,
                avatarType: gameState.myAvatarType,
                avatarData: gameState.myAvatarData,
                ante: selectedAnteOnline,
                joinedAt: Date.now(),
                isSpectator: gameState.isSpectator
            });

            document.getElementById('joinLobbyBtn').classList.add('hidden');
            document.getElementById('lobbyPlayersList').classList.remove('hidden');

            // Listen for players and game start
            const playersRef = ref(database, `rooms/${gameState.roomCode}/players`);
            onValue(playersRef, (snapshot) => {
                updateLobbyPlayers(snapshot.val());
            });

            const roomRef = ref(database, `rooms/${gameState.roomCode}`);
            onValue(roomRef, (snapshot) => {
                const room = snapshot.val();
                if (room && room.status === 'playing') {
                    loadGameFromFirebase(room);
                }
            });
        }

        function updateLobbyPlayers(playersData) {
            if (!playersData) return;

            const players = Object.values(playersData);
            const container = document.getElementById('playersListContainer');
            container.innerHTML = players.map(p => `
                <div style="background: white; padding: 10px; margin: 5px 0; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #e3f2fd; display: flex; align-items: center; justify-content: center; font-size: 1.5em;">
                        ${p.avatarType === 'emoji' ? p.avatar : 'üë§'}
                    </div>
                    <div style="flex: 1;">
                        <strong>${p.name}</strong> ${p.id === gameState.myPlayerId ? '(You)' : ''}
                        ${p.isSpectator ? '<span style="color: #ff9800;">(Spectator)</span>' : ''}
                    </div>
                    <div>$${p.ante}</div>
                </div>
            `).join('');

            // Show start button for host
            get(ref(database, `rooms/${gameState.roomCode}`)).then((snapshot) => {
                const room = snapshot.val();
                const activePlayers = players.filter(p => !p.isSpectator);
                if (room && room.host === gameState.myPlayerId && activePlayers.length >= 2) {
                    document.getElementById('startGameBtn').classList.remove('hidden');
                }
            });
        }

        async function startOnlineGame() {
            const roomRef = ref(database, `rooms/${gameState.roomCode}`);
            const snapshot = await get(roomRef);
            const room = snapshot.val();
            const playersData = room.players;

            const activePlayers = Object.values(playersData).filter(p => !p.isSpectator);
            
            gameState.players = activePlayers.map(p => {
                const player = {
                    id: p.id,
                    name: p.name,
                    avatar: p.avatar || 'üë§',
                    avatarType: p.avatarType || 'emoji',
                    wins: 0,
                    losses: 0,
                    netWinnings: 0,
                    isSpectator: false
                };
                
                // Only add avatarData if it exists
                if (p.avatarData) {
                    player.avatarData = p.avatarData;
                }
                
                return player;
            });

            // Add spectators
            const spectators = Object.values(playersData).filter(p => p.isSpectator);
            spectators.forEach(s => {
                const spectator = {
                    id: s.id,
                    name: s.name,
                    avatar: s.avatar || 'üë§',
                    avatarType: s.avatarType || 'emoji',
                    wins: 0,
                    losses: 0,
                    netWinnings: 0,
                    isSpectator: true
                };
                
                if (s.avatarData) {
                    spectator.avatarData = s.avatarData;
                }
                
                gameState.players.push(spectator);
            });

            gameState.ante = activePlayers[0].ante;
            gameState.housePot = activePlayers.length * gameState.ante;
            gameState.deck = createDeck();
            gameState.currentPlayerIndex = 0;
            gameState.roundNumber = 1;

            dealInitialCards();

            // Clean data before sending to Firebase
            const cleanGameState = cleanForFirebase({
                players: gameState.players,
                housePot: gameState.housePot,
                currentPlayerIndex: 0,
                deck: gameState.deck,
                playerHands: gameState.playerHands,
                roundNumber: 1,
                ante: gameState.ante
            });

            // Save to Firebase
            await update(roomRef, {
                status: 'playing',
                gameState: cleanGameState
            });
        }

        function loadGameFromFirebase(room) {
            const state = room.gameState;
            gameState.players = state.players;
            gameState.housePot = state.housePot;
            gameState.currentPlayerIndex = state.currentPlayerIndex;
            gameState.deck = state.deck;
            gameState.playerHands = state.playerHands;
            gameState.roundNumber = state.roundNumber || 1;
            gameState.ante = state.ante;

            // Check if I'm a spectator
            const me = gameState.players.find(p => p.id === gameState.myPlayerId);
            if (me) {
                gameState.isSpectator = me.isSpectator;
            }

            showGameScreen();

            // Listen for updates
            const gameStateRef = ref(database, `rooms/${gameState.roomCode}/gameState`);
            gameStateListener = onValue(gameStateRef, (snapshot) => {
                const state = snapshot.val();
                if (state) {
                    syncGameState(state);
                }
            });
        }

        function syncGameState(state) {
            const oldPlayerIndex = gameState.currentPlayerIndex;
            
            gameState.players = state.players;
            gameState.housePot = state.housePot;
            gameState.currentPlayerIndex = state.currentPlayerIndex;
            gameState.deck = state.deck;
            gameState.playerHands = state.playerHands;
            gameState.roundNumber = state.roundNumber || gameState.roundNumber;
            
            if (state.drawnCard) {
                gameState.drawnCard = state.drawnCard;
            }

            updateGameDisplay();

            // If turn changed, reset UI
            if (oldPlayerIndex !== gameState.currentPlayerIndex) {
                hideAllControls();
                showCurrentTurnControls();
            }

            // Show result if available
            if (state.lastResult && state.lastResult.playerIndex === oldPlayerIndex && oldPlayerIndex !== gameState.currentPlayerIndex) {
                // Turn just changed, show last result briefly
                if (state.drawnCard) {
                    showBigCard(state.drawnCard, state.lastResult.result);
                }
            }
        }

        function leaveLobby() {
            if (gameState.roomCode && gameState.myPlayerId) {
                const playerRef = ref(database, `rooms/${gameState.roomCode}/players/${gameState.myPlayerId}`);
                remove(playerRef);
            }
            backToModeSelection();
        }

        // Game Display Functions
        function showGameScreen() {
            hideAllScreens();
            document.getElementById('gameScreen').classList.add('active');
            
            if (gameState.isSpectator) {
                document.getElementById('spectatorBanner').classList.remove('hidden');
            }

            // Show chat
            document.getElementById('chatContainer').style.display = 'flex';
            setupChatListener();

            updateGameDisplay();
            showCurrentTurnControls();
        }

        function updateGameDisplay() {
            // Update house pot
            document.getElementById('housePotAmount').textContent = gameState.housePot;
            document.getElementById('roundNumber').textContent = gameState.roundNumber;

            // Render player positions
            renderPlayerPositions();
        }

        function renderPlayerPositions() {
            const container = document.getElementById('playerPositions');
            container.innerHTML = '';

            gameState.players.forEach((player, index) => {
                const position = document.createElement('div');
                position.className = `player-position pos-${index}`;
                
                const isCurrentPlayer = index === gameState.currentPlayerIndex;
                const avatarClass = `player-avatar ${isCurrentPlayer ? 'active' : ''} ${player.isSpectator ? 'spectator' : ''}`;

                let avatarContent;
                if (player.avatarType === 'image' && player.avatarData) {
                    avatarContent = `<img src="${player.avatarData}" alt="${player.name}">`;
                } else {
                    avatarContent = player.avatar;
                }

                // Get player's cards if they have any
                const hand = gameState.playerHands[index] || [];
                const cardsHTML = hand.map(card => `
                    <div class="mini-card ${card.color}">
                        <div>${card.value}</div>
                        <div class="suit">${card.suit}</div>
                    </div>
                `).join('');

                position.innerHTML = `
                    <div class="${avatarClass}">
                        ${avatarContent}
                    </div>
                    <div class="player-info">
                        <div class="player-name">${player.name}</div>
                        <div class="player-stats">
                            <span class="wins">${player.wins}W</span> / 
                            <span class="losses">${player.losses}L</span>
                            ${player.isSpectator ? '' : `<br>Net: $${player.netWinnings >= 0 ? '+' : ''}${player.netWinnings}`}
                        </div>
                        ${player.isSpectator ? '<div style="color: #ff9800; font-size: 0.8em;">Spectating</div>' : ''}
                        <div class="player-cards">${cardsHTML}</div>
                    </div>
                `;

                container.appendChild(position);
            });
        }

        // Turn Control Functions
        function showCurrentTurnControls() {
            hideAllControls();

            const currentPlayer = gameState.players[gameState.currentPlayerIndex];
            const isMyTurn = currentPlayer && currentPlayer.id === gameState.myPlayerId;
            
            document.getElementById('currentPlayerName').textContent = currentPlayer ? currentPlayer.name : 'Player';

            if (gameState.isSpectator) {
                document.getElementById('waitingMessage').classList.remove('hidden');
                return;
            }

            if (isMyTurn && !currentPlayer.isSpectator) {
                document.getElementById('startTurnBtn').classList.remove('hidden');
            } else {
                document.getElementById('waitingMessage').classList.remove('hidden');
            }
        }

        function hideAllControls() {
            document.getElementById('bettingSection').classList.add('hidden');
            document.getElementById('guessSection').classList.add('hidden');
            document.getElementById('startTurnBtn').classList.add('hidden');
            document.getElementById('waitingMessage').classList.add('hidden');
            document.getElementById('resultPanel').classList.remove('active');
        }

        function startTurn() {
            document.getElementById('startTurnBtn').classList.add('hidden');
            document.getElementById('bettingSection').classList.remove('hidden');

            // Set up betting slider
            const minBet = gameState.ante;
            const maxBet = gameState.housePot;
            
            document.getElementById('betSlider').min = minBet;
            document.getElementById('betSlider').max = maxBet;
            document.getElementById('betSlider').value = minBet;
            document.getElementById('minBet').textContent = minBet;
            document.getElementById('maxBet').textContent = maxBet;
            
            gameState.currentBet = minBet;
            gameState.betLocked = false;
            updateBetDisplay();
        }

        function updateBetDisplay() {
            if (gameState.betLocked) return;
            gameState.currentBet = parseInt(document.getElementById('betSlider').value);
            document.getElementById('betAmount').textContent = gameState.currentBet;
        }

        function setQuickBet(percentage) {
            if (gameState.betLocked) return;
            const minBet = parseInt(document.getElementById('betSlider').min);
            const maxBet = parseInt(document.getElementById('betSlider').max);
            const betAmount = minBet + Math.floor((maxBet - minBet) * percentage);
            document.getElementById('betSlider').value = betAmount;
            updateBetDisplay();
        }

        function confirmBet() {
            gameState.betLocked = true;
            document.getElementById('bettingSection').classList.add('hidden');
            document.getElementById('guessSection').classList.remove('hidden');
        }

        async function makeGuess(guess) {
            document.getElementById('guessSection').classList.add('hidden');

            // Draw card
            if (gameState.deck.length === 0) {
                gameState.deck = createDeck();
            }
            
            gameState.drawnCard = gameState.deck.pop();
            const hand = gameState.playerHands[gameState.currentPlayerIndex];
            
            // Check result
            const result = checkGuess(hand, gameState.drawnCard, guess);
            
            // Update player stats
            const player = gameState.players[gameState.currentPlayerIndex];
            if (result === 'win') {
                player.wins++;
                player.netWinnings += gameState.currentBet;
                gameState.housePot -= gameState.currentBet;
            } else {
                player.losses++;
                player.netWinnings -= gameState.currentBet;
                gameState.housePot += gameState.currentBet;
            }

            // Show big card animation
            await showBigCard(gameState.drawnCard, result);

            // Update Firebase if online
            if (gameState.mode === 'online' && gameState.roomCode) {
                const gameStateRef = ref(database, `rooms/${gameState.roomCode}/gameState`);
                const updateData = cleanForFirebase({
                    players: gameState.players,
                    housePot: gameState.housePot,
                    drawnCard: gameState.drawnCard,
                    currentPlayerIndex: gameState.currentPlayerIndex,
                    deck: gameState.deck,
                    playerHands: gameState.playerHands,
                    roundNumber: gameState.roundNumber,
                    lastResult: {
                        playerIndex: gameState.currentPlayerIndex,
                        guess: guess,
                        result: result,
                        bet: gameState.currentBet
                    }
                });
                await update(gameStateRef, updateData);
            }

            // Show result panel
            showResultPanel(result, gameState.currentBet);

            // Auto-advance after delay
            setTimeout(() => {
                nextPlayer();
            }, 3000);
        }

        function checkGuess(hand, drawn, guess) {
            const [card1, card2] = hand;
            const min = card1.numValue;
            const max = card2.numValue;
            const drawnValue = drawn.numValue;

            // If card matches, always lose
            if (drawnValue === min || drawnValue === max) {
                return 'loss';
            }

            const isBetween = drawnValue > min && drawnValue < max;

            if ((guess === 'in' && isBetween) || (guess === 'out' && !isBetween)) {
                return 'win';
            } else {
                return 'loss';
            }
        }

        async function showBigCard(card, result) {
            const overlay = document.getElementById('cardRevealOverlay');
            const bigCard = document.getElementById('bigCard');
            const bigCardValue = document.getElementById('bigCardValue');
            const bigCardSuit = document.getElementById('bigCardSuit');

            bigCard.className = `big-card ${card.color}`;
            bigCardValue.textContent = card.value;
            bigCardSuit.textContent = card.suit;

            overlay.classList.add('active');

            // Show celebration or mocking
            if (result === 'win') {
                showCelebration();
            } else {
                showMocking();
            }

            await new Promise(resolve => setTimeout(resolve, 2500));
            overlay.classList.remove('active');
        }

        function showCelebration() {
            // Create confetti
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1'][Math.floor(Math.random() * 4)];
                    confetti.style.animationDelay = Math.random() * 0.3 + 's';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 2000);
                }, i * 20);
            }

            // Show celebration emoji
            const celebration = document.createElement('div');
            celebration.className = 'celebration';
            celebration.textContent = 'üéâ';
            document.getElementById('cardRevealOverlay').appendChild(celebration);
            setTimeout(() => celebration.remove(), 1000);
        }

        function showMocking() {
            // Show mocking emoji
            const celebration = document.createElement('div');
            celebration.className = 'celebration';
            celebration.textContent = ['üò¢', 'üò≠', 'üí∏', 'üòû'][Math.floor(Math.random() * 4)];
            document.getElementById('cardRevealOverlay').appendChild(celebration);
            setTimeout(() => celebration.remove(), 1000);
        }

        function showResultPanel(result, amount) {
            const panel = document.getElementById('resultPanel');
            const icon = document.getElementById('resultIcon');
            const text = document.getElementById('resultText');

            panel.className = 'result-panel active ' + result;
            
            if (result === 'win') {
                icon.textContent = 'üéâ';
                text.textContent = `You won $${amount}!`;
            } else {
                icon.textContent = 'üò¢';
                const hand = gameState.playerHands[gameState.currentPlayerIndex];
                const isMatch = gameState.drawnCard && (
                    gameState.drawnCard.numValue === hand[0].numValue ||
                    gameState.drawnCard.numValue === hand[1].numValue
                );
                
                if (isMatch) {
                    text.textContent = `Card matched! You lost $${amount}`;
                } else {
                    text.textContent = `Wrong guess! You lost $${amount}`;
                }
            }
        }

        async function nextPlayer() {
            // Check game over
            if (gameState.housePot <= 0) {
                showGameOverModal();
                return;
            }

            // Move to next non-spectator player
            do {
                gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
            } while (gameState.players[gameState.currentPlayerIndex].isSpectator);

            // Increment round if we've gone full circle
            if (gameState.currentPlayerIndex === 0) {
                gameState.roundNumber++;
            }

            // Deal new cards
            if (gameState.deck.length < 2) {
                gameState.deck = createDeck();
            }
            gameState.playerHands[gameState.currentPlayerIndex] = [gameState.deck.pop(), gameState.deck.pop()];
            gameState.playerHands[gameState.currentPlayerIndex].sort((a, b) => a.numValue - b.numValue);

            gameState.drawnCard = null;
            gameState.currentBet = 0;
            gameState.betLocked = false;

            // Update Firebase if online
            if (gameState.mode === 'online' && gameState.roomCode) {
                const gameStateRef = ref(database, `rooms/${gameState.roomCode}/gameState`);
                const updateData = cleanForFirebase({
                    currentPlayerIndex: gameState.currentPlayerIndex,
                    deck: gameState.deck,
                    playerHands: gameState.playerHands,
                    players: gameState.players,
                    housePot: gameState.housePot,
                    roundNumber: gameState.roundNumber
                });
                await update(gameStateRef, updateData);
            }

            updateGameDisplay();
            showCurrentTurnControls();
        }

        // Chat Functions
        function toggleChat() {
            const container = document.getElementById('chatContainer');
            const toggle = document.getElementById('chatToggle');
            
            if (container.classList.contains('minimized')) {
                container.classList.remove('minimized');
                toggle.textContent = '‚àí';
            } else {
                container.classList.add('minimized');
                toggle.textContent = '+';
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const chatData = {
                id: Date.now(),
                senderId: gameState.myPlayerId,
                senderName: gameState.players.find(p => p.id === gameState.myPlayerId)?.name || 'Unknown',
                senderAvatar: gameState.myAvatar,
                senderAvatarType: gameState.myAvatarType,
                senderAvatarData: gameState.myAvatarData,
                message: message,
                timestamp: Date.now(),
                type: 'message'
            };

            // Add to local chat
            displayChatMessage(chatData);

            // Send to Firebase if online
            if (gameState.mode === 'online' && gameState.roomCode) {
                const chatRef = ref(database, `rooms/${gameState.roomCode}/chat/${chatData.id}`);
                await set(chatRef, chatData);
            }

            input.value = '';
        }

        async function sendReaction(emoji) {
            const chatData = {
                id: Date.now(),
                senderId: gameState.myPlayerId,
                senderName: gameState.players.find(p => p.id === gameState.myPlayerId)?.name || 'Unknown',
                senderAvatar: gameState.myAvatar,
                senderAvatarType: gameState.myAvatarType,
                senderAvatarData: gameState.myAvatarData,
                message: emoji,
                timestamp: Date.now(),
                type: 'reaction'
            };

            displayChatMessage(chatData);

            if (gameState.mode === 'online' && gameState.roomCode) {
                const chatRef = ref(database, `rooms/${gameState.roomCode}/chat/${chatData.id}`);
                await set(chatRef, chatData);
            }
        }

        function displayChatMessage(chatData) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            const isOwn = chatData.senderId === gameState.myPlayerId;
            messageDiv.className = `chat-message ${isOwn ? 'own' : ''}`;

            let avatarContent;
            if (chatData.senderAvatarType === 'image' && chatData.senderAvatarData) {
                avatarContent = `<img src="${chatData.senderAvatarData}" alt="${chatData.senderName}">`;
            } else {
                avatarContent = chatData.senderAvatar;
            }

            if (chatData.type === 'reaction') {
                messageDiv.innerHTML = `
                    <div class="chat-avatar">${avatarContent}</div>
                    <div class="chat-bubble">
                        <div class="chat-sender">${chatData.senderName}</div>
                        <div class="chat-text" style="font-size: 2em; text-align: center;">${chatData.message}</div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="chat-avatar">${avatarContent}</div>
                    <div class="chat-bubble">
                        <div class="chat-sender">${chatData.senderName}</div>
                        <div class="chat-text">${escapeHtml(chatData.message)}</div>
                    </div>
                `;
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function setupChatListener() {
            if (gameState.mode === 'online' && gameState.roomCode) {
                const chatRef = ref(database, `rooms/${gameState.roomCode}/chat`);
                onValue(chatRef, (snapshot) => {
                    const messages = snapshot.val();
                    if (messages) {
                        const messagesContainer = document.getElementById('chatMessages');
                        messagesContainer.innerHTML = ''; // Clear existing
                        
                        // Sort by timestamp
                        const sortedMessages = Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);
                        
                        sortedMessages.forEach(msg => {
                            displayChatMessage(msg);
                        });
                    }
                });
            }
        }

        function showGameOverModal() {
            // Calculate final scores and winner
            const activePlayers = gameState.players.filter(p => !p.isSpectator);
            const sortedPlayers = [...activePlayers].sort((a, b) => b.netWinnings - a.netWinnings);
            
            const finalScoresList = document.getElementById('finalScoresList');
            finalScoresList.innerHTML = sortedPlayers.map((player, index) => {
                const isWinner = index === 0;
                return `
                    <div class="score-row ${isWinner ? 'winner' : ''}">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${isWinner ? '<span style="font-size: 2em;">üëë</span>' : ''}
                            <strong>${player.name}</strong>
                        </div>
                        <div>
                            <div style="font-size: 1.2em; font-weight: bold; color: ${player.netWinnings >= 0 ? '#4ecdc4' : '#ff6b6b'};">
                                ${player.netWinnings >= 0 ? '+' : ''}$${player.netWinnings}
                            </div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${player.wins}W / ${player.losses}L
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('gameOverModal').style.display = 'flex';
        }

        async function reBetSameGame() {
            // Reset player stats but keep players
            gameState.players.forEach(player => {
                if (!player.isSpectator) {
                    player.wins = 0;
                    player.losses = 0;
                    player.netWinnings = 0;
                }
            });

            // Reset house pot with same ante
            const activePlayers = gameState.players.filter(p => !p.isSpectator);
            gameState.housePot = activePlayers.length * gameState.ante;
            gameState.roundNumber = 1;
            gameState.currentPlayerIndex = 0;
            
            // Create new deck and deal
            gameState.deck = createDeck();
            dealInitialCards();

            // Update Firebase if online
            if (gameState.mode === 'online' && gameState.roomCode) {
                const gameStateRef = ref(database, `rooms/${gameState.roomCode}/gameState`);
                await update(gameStateRef, {
                    players: gameState.players,
                    housePot: gameState.housePot,
                    roundNumber: gameState.roundNumber,
                    currentPlayerIndex: 0,
                    deck: gameState.deck,
                    playerHands: gameState.playerHands
                });
            }

            // Hide modal and continue
            document.getElementById('gameOverModal').style.display = 'none';
            updateGameDisplay();
            showCurrentTurnControls();
        }

        async function resetGame() {
            if (gameState.mode === 'online' && gameState.roomCode) {
                if (gameStateListener) {
                    gameStateListener();
                }
                const roomRef = ref(database, `rooms/${gameState.roomCode}`);
                await remove(roomRef);
            }
            location.reload();
        }

        // Check URL for room code
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomCode = urlParams.get('room');
            if (roomCode && isFirebaseEnabled) {
                document.getElementById('roomCodeInput').value = roomCode;
                showOnlineSetup();
                setTimeout(() => {
                    showJoinRoom();
                }, 500);
            }
        });
    </script>
</body>
</html>
